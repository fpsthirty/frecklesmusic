name: ESLint Check
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  eslint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci

      - name: Run ESLint
        id: eslint-check
        run: |
          npm run lint && echo "result=success" >> $GITHUB_OUTPUT || echo "result=failed" >> $GITHUB_OUTPUT
   
      - name: Update ESLint Badge in Gist
        if: always()
        uses: actions/github-script@v6
        env:
          GIST_ID: "6d9dd6bdaeecff45b56e0baee799ed2e"
          GH_PAT: ${{ secrets.GH_PAT }}  # Используем персональный токен
        with:
          script: |
            try {
              const result = "${{ steps.eslint-check.outputs.result }}";
              const isPassing = result === 'success';
              
              # Создаем экземпляр GitHub с кастомным токеном; создаётся здесь: https://github.com/settings/tokens , используется здесь: https://github.com/fpsthirty/frecklesmusic/settings/secrets/actions
              const githubWithToken = new github.GitHub(process.env.GH_PAT);

              await githubWithToken.rest.gists.update({
                gist_id: process.env.GIST_ID,
                files: {
                  'frecklesmusic-eslint-badge.json': {
                    content: JSON.stringify({
                      schemaVersion: 1,
                      label: "ESLint",
                      message: isPassing ? "valid" : "invalid",
                      color: isPassing ? "brightgreen" : "red",
                    })
                  }
                }
              });
              console.log('Gist updated successfully!');
            } catch (error) {
              console.error('Gist update failed:', error);
              throw error;
            }