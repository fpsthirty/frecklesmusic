name: W3C Validation
on: [push]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Install Validator
        run: npm install -g w3c-html-validator@5.0.1  # Явно указываем версию
      
      - name: Run Validation
        run: |
          # Проверяем доступность URL
          if ! curl -s -o /dev/null -w "%{http_code}" https://fpsthirty.github.io/frecklesmusic/ | grep -q 200; then
            echo "::error::Website is not available"
            exit 1
          fi
          
          # Запускаем валидатор с актуальными флагами
          npx w3c-html-validator \
            --format=json \
            --quiet \
            https://fpsthirty.github.io/frecklesmusic/ > docs/w3c-results.json
          
          # Проверяем результаты
          ERROR_COUNT=$(jq -r '.messages[] | select(.type == "error") | .message' docs/w3c-results.json | wc -l)
          if [ "$ERROR_COUNT" -gt 0 ]; then
            echo "::error::Found $ERROR_COUNT W3C validation errors"
            jq -r '.messages[] | select(.type == "error") | "::error file=\(.extract)::Line \(.lastLine): \(.message)"' docs/w3c-results.json
            exit 1
          else
            echo "::notice::W3C validation passed successfully"
          fi
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: w3c-validation-results
          path: docs/w3c-results.json